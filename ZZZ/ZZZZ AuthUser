<?php
// database.php - Configuration de la base de données
try {
    $user = "root"; // Nom d'utilisateur de la base de données
    $pass = "";    // Mot de passe de la base de données
    $bdd = new PDO('mysql:host=localhost;dbname=ppe_hotel', $user, $pass);
    $bdd->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("Erreur ! : " . $e->getMessage());
}
?>

<?php
// ModelUser.php - Modèle pour gérer les utilisateurs
class Utilisateur {
    private $bdd;

    public function __construct($bdd) {
        $this->bdd = $bdd;
    }

    // Ajouter un utilisateur
    public function ajouterUtilisateur($nom, $prenom, $email, $pass, $roles) {
        $hashPassword = password_hash($pass, PASSWORD_BCRYPT);
        $req = $this->bdd->prepare("INSERT INTO UTILISATEURS (nom, prenom, email, pass, roles) VALUES (:nom, :prenom, :email, :pass, :roles)");
        $req->bindParam(':nom', $nom);
        $req->bindParam(':prenom', $prenom);
        $req->bindParam(':email', $email);
        $req->bindParam(':pass', $hashPassword);
        $req->bindParam(':roles', $roles);
        return $req->execute();
    }

    // Vérifier la connexion
    public function checkLogin($email, $password) {
        $req = $this->bdd->prepare("SELECT * FROM UTILISATEURS WHERE email = :email");
        $req->bindParam(':email', $email);
        $req->execute();
        $user = $req->fetch(PDO::FETCH_ASSOC);
        if ($user && password_verify($password, $user['pass'])) {
            return $user;
        }
        return false;
    }
}
?>

<?php
// ControllerUser.php - Contrôleur pour gérer l'authentification
include('../modele/ModelUser.php');
include('../bdd/database.php');

if (isset($_POST['action'])) {
    $UtilisateurController = new UtilisateurController($bdd);
    switch ($_POST['action']) {
        case 'inscription':
            $UtilisateurController->create();
            break;
        case 'login':
            $UtilisateurController->login();
            break;
        default:
            echo "Action inconnue.";
            break;
    }
}

class UtilisateurController {
    private $utilisateur;

    public function __construct($bdd) {
        $this->utilisateur = new Utilisateur($bdd);
    }

    public function create() {
        $this->utilisateur->ajouterUtilisateur(
            $_POST['nom'],
            $_POST['prenom'],
            $_POST['email'],
            $_POST['password'],
            'client' // Rôle par défaut
        );
        header('Location: ../vues/User_inscription_login.php?success=inscription');
    }

    public function login() {
        $user = $this->utilisateur->checkLogin($_POST['email'], $_POST['password']);
        if ($user) {
            session_start();
            $_SESSION['user'] = $user;
            header('Location: ../vues/dashboard.php'); // Page d'accueil après connexion
        } else {
            header('Location: ../vues/User_inscription_login.php?error=login');
        }
    }
}
?>

<!-- User_inscription_login.php - Vue pour inscription et connexion -->
<div>
    <h1>Inscription</h1>
    <form action="../controleur/ControllerUser.php" method="POST">
        <label>Nom</label>
        <input type="text" name="nom" required><br>

        <label>Prénom</label>
        <input type="text" name="prenom" required><br>

        <label>Email</label>
        <input type="email" name="email" required><br>

        <label>Mot de passe</label>
        <input type="password" name="password" required><br>

        <input type="hidden" name="action" value="inscription">
        <input type="submit" value="S'inscrire">
    </form>
</div>

<div>
    <h1>Connexion</h1>
    <form action="../controleur/ControllerUser.php" method="POST">
        <label>Email</label>
        <input type="email" name="email" required><br>

        <label>Mot de passe</label>
        <input type="password" name="password" required><br>

        <input type="hidden" name="action" value="login">
        <input type="submit" value="Se connecter">
    </form>
</div>
